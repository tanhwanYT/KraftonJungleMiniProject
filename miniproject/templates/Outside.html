<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì™¸ì‹ ê°¤ëŸ¬ë¦¬ - Jungle Food</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/Outside.css') }}"/>

  <!-- Kakao Map SDK: autoload ë¹„í™œì„±í™” í›„ load ì½œë°±ì—ì„œ ì´ˆê¸°í™” -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=602f6de5c313013c3c677ff954acc4d0&libraries=services&autoload=false" defer></script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet"/>
</head>
<body>
  <header>
    <h1>Restaurant</h1>
    <a href="{{ url_for('main_page') }}" class="back-btn">ë©”ì¸ìœ¼ë¡œ</a>
  </header>

  <div id="map"></div>

  <main>
    <section class="board-posts">
      <h3>Article</h3>
      <!-- í•„ìš” ì‹œ ê²Œì‹œíŒë³„ë¡œ ë‚˜ëˆ„ì–´ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ULì„ ë‘ ê°œë¡œ ë¶„ë¦¬í•˜ì„¸ìš” -->
      <ul id="post-list"></ul>
    </section>
  </main>

  <script>
    // ê³µìš© ìœ í‹¸
    function escapeHtml(s){
      return (s||"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    // Kakao ì§€ë„ ì´ˆê¸°í™” (SDK ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰)
    function initMap(){
      const mapContainer = document.getElementById('map');
      if (!mapContainer) return;

      const mapOption = {
        center: new kakao.maps.LatLng(37.269703996199404, 127.20784395278321),
        level: 4
      };
      const map = new kakao.maps.Map(mapContainer, mapOption);
      const infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
      const ps = new kakao.maps.services.Places(map);

      // ì¹´í…Œê³ ë¦¬: ìŒì‹ì (FD6), í¸ì˜ì (CS2)
      const cb = (data, status) => {
        if (status !== kakao.maps.services.Status.OK) return;
        data.forEach(place => {
          const marker = new kakao.maps.Marker({
            map,
            position: new kakao.maps.LatLng(place.y, place.x)
          });
          kakao.maps.event.addListener(marker, 'click', () => {
            infowindow.setContent('<div style="padding:5px;font-size:12px;">' + escapeHtml(place.place_name) + '</div>');
            infowindow.open(map, marker);
          });
        });
      };

      ps.categorySearch('FD6', cb, { useMapBounds: true });
      ps.categorySearch('CS2', cb, { useMapBounds: true });

      // ê¸°ì¤€ì (í•„ìš” ì‹œ)
      new kakao.maps.Marker({
        map,
        position: new kakao.maps.LatLng(37.269703996199404, 127.20784395278321)
      });
    }

    // ê²Œì‹œê¸€ ë Œë”
    async function renderPosts({ board = "Delivery", page = 1, perPage = 10 } = {}){
      const list = document.getElementById("post-list");
      if (!list) return;

      list.innerHTML = "<li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>";

      try {
        const res = await fetch(`/api/posts?board=${encodeURIComponent(board)}&page=${page}&per_page=${perPage}`);
        const json = await res.json();
        if (!res.ok || !json.success) throw new Error("API ì‹¤íŒ¨");

        list.innerHTML = "";
        json.data.items.forEach(p => {
          const li = document.createElement("li");
          li.innerHTML = `
            <a href="/post/view?id=${encodeURIComponent(p.id)}" class="post-link">
              <!-- ì¸ë„¤ì¼ì´ ìˆë‹¤ë©´ <img class="thumb" src="..." alt=""> ì‚¬ìš© -->
              <div class="post-info">
                <div class="title-text">${escapeHtml(p.title)}</div>
                <div class="meta-row">ğŸ“‚ ${escapeHtml(p.board)} &nbsp;|&nbsp; ğŸ‘¤ ${escapeHtml(p.author)} &nbsp;|&nbsp; ğŸ•’ ${new Date(p.created_at).toLocaleString()}</div>
              </div>
            </a>`;
          list.appendChild(li);
        });

        if (json.data.items.length === 0){
          list.innerHTML = "<li>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
        }
      } catch (e){
        console.warn(e);
        list.innerHTML = "<li>ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>";
      }
    }

    // DOM ì¤€ë¹„ë˜ë©´: SDK ë¡œë“œ í›„ ì§€ë„ â†’ ê²Œì‹œê¸€
    document.addEventListener("DOMContentLoaded", () => {
      // Kakao SDKê°€ deferë¡œ ë¡œë“œë˜ë¯€ë¡œ, kakaoê°€ ì¡´ì¬í•˜ëŠ” ì‹œì ì— load í˜¸ì¶œ
      if (window.kakao && kakao.maps && kakao.maps.load){
        kakao.maps.load(initMap);
      } else {
        // í˜¹ì‹œ ëª¨ë¥¼ ì§€ì—° ëŒ€ë¹„
        const t = setInterval(() => {
          if (window.kakao && kakao.maps && kakao.maps.load){
            clearInterval(t);
            kakao.maps.load(initMap);
          }
        }, 50);
        setTimeout(() => clearInterval(t), 5000);
      }

      // í•˜ë‚˜ì˜ ë³´ë“œë§Œ ë³´ì—¬ì¤„ ê²½ìš°
      renderPosts({ board: "Delivery", page: 1, perPage: 10 });

      // ë‘ ê°œ ë³´ë“œë¥¼ ëª¨ë‘ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤ë©´ ULì„ ë‘ ê°œë¡œ ë‚˜ëˆ„ê±°ë‚˜,
      // ì—¬ê¸°ì„œ ì´ì–´ì„œ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì— renderPosts({ board: "Cafeteria" })ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”.
    });
  </script>
</body>
</html>