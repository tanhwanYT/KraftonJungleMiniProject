<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë©”ì¸í˜ì´ì§€ - Jungle Food</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Flask static -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

  <style>
    .side-auth {
      position: fixed;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    .side-auth .btn {
      display: inline-block;
      padding: 10px 16px;
      background: #37b43dff;
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,1);
      text-align: center;
    }
    .side-auth .btn:hover { background:#53dd5c; color:#000; }
    .side-auth .btn.outline {
      background: transparent;
      color: #ffffffff;
      border: 2px solid #113f13;
    }
    .side-auth .btn.outline:hover { background:#113f13; color:#fff; }

    /* ìµœì‹ ê¸€ ë¦¬ìŠ¤íŠ¸ ê°„ë‹¨ ìŠ¤íƒ€ì¼ */
    #post-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
    #post-list li {
      border: 1px solid #e5e5e5; border-radius: 10px; padding: 2px;
      display: grid; grid-template-columns: 96px 1fr; gap: px; align-items: center;
      cursor: pointer; transition: box-shadow .2s ease;
    }
    #post-list li:hover { box-shadow: 0 4px 18px rgba(255, 255, 255, 0.3); }
    .thumb {
      width: 96px; height: 96px; border-radius: 8px; object-fit: cover; background: #f5f5f5;
    }
    .meta { font-size: 12px; color: #666; margin-top: 4px; }
    .empty { color: #999; padding: 16px 0; }
    .category-nav { display: flex; margin: 10px 0 20px; }
    .category-nav button { padding: 8px 10px; border-radius: 10px; border: 1px solid #cbd5e1; background: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <button type="button" class="write-btn" onclick="location.href='{{ url_for('write_page') }}'">
      ê¸€ì“°ê¸°
    </button>
    <h1>Jungle Food</h1>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      <i class="fa fa-search search-icon" id="searchBtn"></i>
    </div>
  </header>

  <!-- ì¹´í…Œê³ ë¦¬: Flaskì˜ ë‹¤ë¥¸ ì •ì  htmlë¡œ ì´ë™í•˜ì§€ ì•Šê³ , ë™ì¼ í˜ì´ì§€ì—ì„œ í•„í„°ë§ -->
  <nav class="category-nav">
    <button type="button" class="cat-btn"
            onclick="location.href='{{ url_for('cafeteria_page') }}'">Cafeteria</button>
    <button type="button" class="cat-btn"
           onclick="location.href='{{ url_for('outside_page') }}'">Restaurant</button>
    <button type="button" class="cat-btn"
            onclick="location.href='{{ url_for('delivery_page') }}'">Delivery Food</button>
  </nav>

  <main>
    <section class="latest-posts">
      <center><h2>Resent Article</h2><center>
      <ul id="post-list">
        <!-- ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ìµœì‹ ê¸€ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
      </ul>
      <div id="post-empty" class="empty" style="display:none;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>

      <!-- ê°„ë‹¨ í˜ì´ì§€ë„¤ì´ì…˜(í•„ìš” ì‹œ ë…¸ì¶œ) -->
      <div id="pager" style="margin-top:12px; display:flex; gap:8px;">
        <button type="button" id="prevBtn" style="display:none;">ì´ì „</button>
        <span id="pageInfo" style="align-self:center;"></span>
        <button type="button" id="nextBtn" style="display:none;">ë‹¤ìŒ</button>
      </div>
    </section>

    {% if user %}
    <aside class="user-container">
      <div class="user-box">
        <h3>User Info</h3>
        <p><span id="userId">{{ user.username }}</span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!!</p>

        <a class="btn danger"
           href="{{ url_for('logout') }}"
           style="display: inline-block; padding: 8px 16px; margin: 4px 2px;
                  background-color: #dc3545; color: white; text-decoration: none;
                  border-radius: 4px; text-align: center; font-size: 14px;
                  transition: background-color 0.3s;"
           onmouseover="this.style.backgroundColor='#c82333'"
           onmouseout="this.style.backgroundColor='#dc3545'">Logout</a>

        <form method="post"
              action="{{ url_for('delete_account') }}"
              onsubmit="return confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
          <button type="submit" class="btn danger">Delete Account</button>
        </form>
      </div>
    </aside>
    {% else %}
    <div class="side-auth">
      <a class="btn btn danger" href="{{ url_for('login_page') }}">ë¡œê·¸ì¸</a>
      <a class="btn outline" href="{{ url_for('register_page') }}">íšŒì›ê°€ì…</a>
    </div>
    {% endif %}
  </main>

  <!-- í•„ìš” ì‹œ ë³„ë„ì˜ JS íŒŒì¼ë¡œ ë¶„ë¦¬ ê°€ëŠ¥ -->
  <script>
  // ëª©ë¡ DOM
  const listEl   = document.getElementById("post-list");
  const emptyEl  = document.getElementById("post-empty");
  const prevBtn  = document.getElementById("prevBtn");
  const nextBtn  = document.getElementById("nextBtn");
  const pageInfo = document.getElementById("pageInfo");

  // ìƒì„¸ í˜ì´ì§€ URL (Flask ë¼ìš°íŠ¸)
  const postViewUrl = "{{ url_for('post_view_page') }}"; // /post/view

  // ê°„ë‹¨í•œ ìƒíƒœ
  let state = { page: 1, perPage: 10, pages: 1, total: 0, items: [] };

  // ì„œë²„ì—ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadPosts() {
    try {
      const params = new URLSearchParams({ page: String(state.page), per_page: String(state.perPage) });
      const res = await fetch(`/api/posts?${params.toString()}`);
      const data = await res.json();

      if (!res.ok || !data.success) throw new Error(data.msg || "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

      const { items, page, pages, total } = data.data;
      state.items = items || [];
      state.page  = page;
      state.pages = pages;
      state.total = total;

      renderPosts(state.items);
      renderPager();
    } catch (e) {
      console.error(e);
      listEl.innerHTML = "";
      if (emptyEl) {
        emptyEl.style.display = "block";
        emptyEl.textContent = "ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }
  }

  // ëª©ë¡ ë Œë”ë§ (ê²Œì‹œê¸€ í´ë¦­ ì‹œ PostView.htmlë¡œ ì´ë™)
function renderPosts(items) {
  listEl.innerHTML = "";
  if (!items || items.length === 0) {
    if (emptyEl) { emptyEl.style.display = "block"; emptyEl.textContent = "ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤."; }
    return;
  }
  if (emptyEl) emptyEl.style.display = "none";

  items.forEach(p => {
    const li = document.createElement("li");
    const imgSrc = (p.images && p.images.length > 0) ? p.images[0] : "";

    // ì¸ë„¤ì¼: ê³ ì • í¬ê¸° + í¬ë¡­ (CSS .thumbê°€ ì²˜ë¦¬)
    const thumbHTML = imgSrc
      ? `<img src="${imgSrc}" alt="thumb" class="thumb" loading="lazy">`
      : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#aaa;font-size:12px;">No Img</div>`;

    const created = new Date(p.created_at)
      .toLocaleString("ko-KR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" })
      .replace(/\./g, "-").replace(/-\s/g, "-").trim();

    const metaHTML = `
      <div class="meta-row" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;color:#555;">
        ğŸ“‚ ${p.board} &nbsp; | &nbsp; ğŸ‘¤ ${p.author} &nbsp; | &nbsp; ğŸ•’ ${created}
      </div>
    `;

    li.innerHTML = `
      <a href="${postViewUrl}?id=${encodeURIComponent(p.id)}" class="post-link">
        ${thumbHTML}
        <div class="post-info" style="display:flex;flex-direction:column;gap:6px;">
          <div class="title-text" style="font-weight:700;font-size:16px;color:#222;">${escapeHtml(p.title)}</div>
          ${metaHTML}
        </div>
      </a>
    `;
    listEl.appendChild(li);
  });
}


  // í˜ì´ì§€ë„¤ì´ì…˜(í•„ìš” ì—†ìœ¼ë©´ ì´ í•¨ìˆ˜ì™€ DOM ì œê±°)
  function renderPager() {
    if (!prevBtn || !nextBtn || !pageInfo) return;
    pageInfo.textContent = state.pages > 0 ? `í˜ì´ì§€ ${state.page} / ${state.pages} (ì´ ${state.total}ê°œ)` : "";
    prevBtn.style.display = (state.page > 1) ? "inline-block" : "none";
    nextBtn.style.display = (state.page < state.pages) ? "inline-block" : "none";
    prevBtn.onclick = () => { if (state.page > 1) { state.page--; loadPosts(); } };
    nextBtn.onclick = () => { if (state.page < state.pages) { state.page++; loadPosts(); } };
  }

  // XSS ë°©ì§€ìš©
  function escapeHtml(str) {
    return (str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // ì´ˆê¸° ë¡œë“œ
  document.addEventListener("DOMContentLoaded", loadPosts);
</script>
</body>
</html>
