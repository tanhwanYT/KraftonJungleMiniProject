<!-- templates/PostWrite.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시물 작성</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/PostWrite.css') }}">
  <style>
    .page { max-width: 900px; margin: 24px auto; padding: 0 12px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    .title-input, .content-input { width:100%; box-sizing:border-box; }
    .title-input { height: 44px; font-size:18px; padding:10px 12px; margin-bottom: 12px; }
    .content-section { position:relative; }
    .content-input { min-height: 220px; padding:12px; font-size:16px; }
    .image-bar { display:flex; align-items:center; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .image-filelist { font-size: 13px; color:#666; }
    .board-select { margin:16px 0; }
    .button-group { display:flex; gap:8px; justify-content:flex-end; margin-top: 18px; }
    .btn.primary { background:#2f855a; color:#fff; border-color:#2f855a; }
    .hint { font-size:12px; color:#888; }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>게시물 작성</h1>
      <a href="{{ url_for('main_page') }}" class="btn">Back</a>
    </header>

    <!-- 작성 폼 -->
    <form id="postForm" enctype="multipart/form-data" onsubmit="return false;">
      <!-- 제목 -->
      <input type="text" name="title" class="title-input" placeholder="제목을 입력하세요" required>

      <!-- 내용 -->
      <div class="content-section">
        <textarea name="content" class="content-input" placeholder="내용을 입력하세요" required></textarea>
      </div>

      <!-- 이미지 업로드 -->
      <div class="image-bar">
        <input id="images" name="images" type="file" accept="image/*" multiple hidden>
        <button type="button" class="btn" id="pickBtn">+ 이미지 선택</button>
        <button type="button" class="btn" id="clearBtn">선택 해제</button>
        <span class="image-filelist" id="fileList">선택된 이미지 없음</span>
      </div>
      <div class="hint">* JPG/PNG/GIF/WEBP, 파일당 최대 5MB, 여러 장 선택 가능</div>

      <!-- 게시판 선택 -->
      <div class="board-select">
        <strong>게시판 선택</strong>
        <div>
          <label><input type="radio" name="board" value="Cafeteria" required> 식당</label>
          <label style="margin-left:12px;"><input type="radio" name="board" value="Outside"> 외식</label>
          <label style="margin-left:12px;"><input type="radio" name="board" value="Delivery"> 배달</label>
        </div>
      </div>

      <!-- 버튼 -->
      <div class="button-group">
        <button type="button" class="btn" onclick="location.href='{{ url_for('main_page') }}'">취소</button>
        <button type="submit" class="btn primary" id="submitBtn">게시</button>
      </div>
    </form>
  </div>

  <script>
    // 요소 참조
    const form = document.getElementById('postForm');
    const imgInput = document.getElementById('images');
    const pickBtn = document.getElementById('pickBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileList = document.getElementById('fileList');

    // 파일 선택 UI
    pickBtn.addEventListener('click', () => imgInput.click());
    clearBtn.addEventListener('click', () => {
      imgInput.value = "";
      fileList.textContent = "선택된 이미지 없음";
    });
    imgInput.addEventListener('change', () => {
      if (!imgInput.files || imgInput.files.length === 0) {
        fileList.textContent = "선택된 이미지 없음";
        return;
      }
      const names = Array.from(imgInput.files).map(f => `${f.name} (${(f.size/1024/1024).toFixed(2)}MB)`);
      fileList.textContent = names.join(", ");
    });

    // 업로드 + 게시
    form.addEventListener('submit', async () => {
      const fd = new FormData(form);

      // 간단한 클라이언트 검증
      const title = (fd.get('title') || '').trim();
      const content = (fd.get('content') || '').trim();
      const board = fd.get('board');
      if (!title || !content || !board) {
        alert('제목/내용/게시판을 모두 입력해 주세요.');
        return;
      }

      // 파일 용량(5MB) 클라이언트 검증(선택)
      if (imgInput.files && imgInput.files.length) {
        for (const f of imgInput.files) {
          if (f.size > 5 * 1024 * 1024) {
            alert(`"${f.name}" 파일이 5MB를 초과합니다.`);
            return;
          }
        }
      }

      try {
        const res = await fetch('/api/posts', { method: 'POST', body: fd });
        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const text = await res.text();
          throw new Error(`JSON이 아닌 응답: ${res.status}\n${text.slice(0,200)}`);
        }
        const json = await res.json();
        if (!res.ok || !json.success) {
          alert(json.msg || '게시 중 오류가 발생했습니다.');
          return;
        }
        // 작성 성공 → 상세 페이지로 이동
        const id = json.data.id;
        alert('게시되었습니다!');
        location.href = `{{ url_for('post_view_page') }}?id=${encodeURIComponent(id)}`;
      } catch (e) {
        console.error(e);
        alert(e.message || '업로드 중 오류가 발생했습니다.');
      }
    });
  </script>
</body>
</html>
